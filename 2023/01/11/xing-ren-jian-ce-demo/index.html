<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="行人检测demo, 莉莉娅！"><meta name="description" content="项目地址dyh/win10_yolov5_deepsort_counting: 在 win10 运行 yolov5 deepsort 行人 车辆 跟踪 检测 计数 (github.com)
环境部署首先先假设我们已经安装好了Anaconda"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="referrer" content="no-referrer-when-downgrade"><title>行人检测demo | 莉莉娅！</title><link rel="icon" type="image/png" href="/Lillia.github.io/favicon.png"><link rel="stylesheet" href="/Lillia.github.io/libs/awesome/css/all.min.css"><link rel="stylesheet" href="/Lillia.github.io/libs/materialize/materialize.min.css"><link rel="stylesheet" href="/Lillia.github.io/libs/aos/aos.css"><link rel="stylesheet" href="/Lillia.github.io/libs/animate/animate.min.css"><link rel="stylesheet" href="/Lillia.github.io/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="/Lillia.github.io/css/matery.css"><link rel="stylesheet" href="/Lillia.github.io/css/my.css"><link rel="stylesheet" href="/Lillia.github.io/css/dark.css" media="none" onload="if(media!='all')media='all'"><link rel="stylesheet" href="/Lillia.github.io/libs/tocbot/tocbot.css"><link rel="stylesheet" href="/Lillia.github.io/css/post.css"><link rel="stylesheet" href="/Lillia.github.io/css/reward.css"><script src="/Lillia.github.io/libs/jquery/jquery-3.6.0.min.js"></script><meta name="generator" content="Hexo 6.3.0"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/Lillia.github.io/atom.xml" title="莉莉娅！" type="application/atom+xml"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/Lillia.github.io/" class="waves-effect waves-light"><img src="/Lillia.github.io/medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">莉莉娅！</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/Lillia.github.io/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/Lillia.github.io/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/Lillia.github.io/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/Lillia.github.io/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/Lillia.github.io/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/Lillia.github.io/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/Lillia.github.io/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li><li><a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式"><i id="sum-moon-icon" class="fas fa-sun" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/Lillia.github.io/medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">莉莉娅！</div><div class="logo-desc">Never really desperate, only the lost of the soul.</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/Lillia.github.io/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/Lillia.github.io/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/Lillia.github.io/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/Lillia.github.io/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/Lillia.github.io/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/Lillia.github.io/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/Lillia.github.io/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i> Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(/Lillia.github.io/medias/featureimages/4.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">行人检测demo</h1></div></div></div></div></div><main class="post-container content"><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/Lillia.github.io/tags/blog/"><span class="chip bg-color">blog</span></a> <a href="/Lillia.github.io/tags/DeepLearning/"><span class="chip bg-color">DeepLearning</span></a> <a href="/Lillia.github.io/tags/YOLOv5/"><span class="chip bg-color">YOLOv5</span></a> <a href="/Lillia.github.io/tags/DeepSORT/"><span class="chip bg-color">DeepSORT</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/Lillia.github.io/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" class="post-category">深度学习</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2023-01-11</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 5.4k</div></div></div><hr class="clearfix"><link rel="stylesheet" href="/Lillia.github.io/libs/prism/prism.min.css"><div class="card-content article-card-content"><div id="articleContent"><h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a href="https://github.com/dyh/win10_yolov5_deepsort_counting">dyh/win10_yolov5_deepsort_counting: 在 win10 运行 yolov5 deepsort 行人 车辆 跟踪 检测 计数 (github.com)</a></p><h2 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h2><p>首先先假设我们已经安装好了Anaconda，</p><p>然后再假设我们安装好了CUDA11.7，</p><p>最好再假设我们安装好了Pycharm，</p><p>首先我们先配置一下python3.9的虚拟环境：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230108211509933.png"><p>首先我们三步走进入condabin文件夹，Anaconda安装目录每个人可能不同。</p><p>接着输入conda create -n counting python=3.9</p><p>一路回车。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230108211815413.png"><p>这样就创建完了，接下来激活虚拟环境，输入conda activate counting，输入后会在前面带有括号。</p><p>在项目文件夹中复制requirements文件到虚拟环境文件夹中，cmd进入虚拟环境文件夹。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109160138285.png"><p>接着输入pip3 install -r requirements.txt，安装项目外部库。</p><p>虚拟环境下输入python -m pip install —upgrade pip升级pip，接下来去<a target="_blank" rel="noopener" href="https://pytorch.org/get-started/locally/">Start Locally | PyTorch</a>找到对应的安装命令，下载对应CUDA版本的Pytorch，因为我电脑环境配置了CUDA11.7，这里就不在虚拟环境配置CUDA了，默认都装好了，这里输入pip3 install torch torchvision torchaudio —extra-index-url <a target="_blank" rel="noopener" href="https://download.pytorch.org/whl/cu117">https://download.pytorch.org/whl/cu117</a> 。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109160206892.png"><p>打开项目文件夹，右键，选择打开文件夹作为Pycharm项目，并且信任项目。</p><p>选择配置好的虚拟环境作为Python解释器。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153403933.png"><p>尝试运行一下。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153443403.png"><p>出现了一个小报错，小修改，将from cv2 import cv2 改成import cv2即可。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153517419.png" title="修改前"> <img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153535399.png" title="修改后"><p>再试试：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153659840.png"><p>又有新报错，查查资料，打开upsampling.py，小做修改。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153808535.png" title="修改前"> <img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153839748.png" title="修改后"><p>再试试：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153916484.png"><p>能跑了，但是没有框框。</p><p>再看看，将detector.py里的model.half改成model.float，img.half改成img.float。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109153952413.png" title="修改前"> <img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109154046732.png" title="修改后"><p>再试试：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109154119832.png"><p>有框框了。</p><p>接下来看看代码。</p><h2 id="代码阅读"><a href="#代码阅读" class="headerlink" title="代码阅读"></a>代码阅读</h2><h3 id="detector-py"><a href="#detector-py" class="headerlink" title="detector.py"></a>detector.py</h3><h4 id="init"><a href="#init" class="headerlink" title="init"></a><strong>init</strong></h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 初始化属性</span>
   <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
       self<span class="token punctuation">.</span>img_size <span class="token operator">=</span> <span class="token number">640</span>     <span class="token comment"># 照片尺寸缩放</span>
       self<span class="token punctuation">.</span>threshold <span class="token operator">=</span> <span class="token number">0.3</span>    <span class="token comment"># 灰度二值化阈值</span>
       self<span class="token punctuation">.</span>stride <span class="token operator">=</span> <span class="token number">1</span>     <span class="token comment"># 卷积步长</span>
       self<span class="token punctuation">.</span>weights <span class="token operator">=</span> <span class="token string">'./weights/yolov5m.pt'</span>  <span class="token comment"># 权重模型，采用yolov5官方权重</span>
       self<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span>   <span class="token comment"># 训练设备根据配置选择显卡或CPU</span>
       self<span class="token punctuation">.</span>device <span class="token operator">=</span> select_device<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
       model <span class="token operator">=</span> attempt_load<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weights<span class="token punctuation">,</span> map_location<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>    <span class="token comment"># 导入模型权重，指定训练设备</span>
       model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       model<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 模型数据类型改为float</span>
       self<span class="token punctuation">.</span>m <span class="token operator">=</span> model  <span class="token comment"># 存放model方法</span>
       self<span class="token punctuation">.</span>names <span class="token operator">=</span> model<span class="token punctuation">.</span>module<span class="token punctuation">.</span>names <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>
           model<span class="token punctuation">,</span> <span class="token string">'module'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> model<span class="token punctuation">.</span>names   <span class="token comment"># 获得识别标签</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="preprocess"><a href="#preprocess" class="headerlink" title="preprocess"></a>preprocess</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 复制图像副本，浅复制</span>
    img0 <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># yolov5图像预处理letterbox，等比缩放到img_size大小，不够的地方补充黑边</span>
    img <span class="token operator">=</span> letterbox<span class="token punctuation">(</span>img<span class="token punctuation">,</span> new_shape<span class="token operator">=</span>self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 对于opencv读取的图像数据来说，储存格式为[B,G,R]，B,G,R为色域比例</span>
    <span class="token comment"># img[:, :, ::-1]指：[B,G,R]翻转成[R,G,B]</span>
    <span class="token comment"># 我没特别理解这步的作用，因为貌似不进行颜色信道的翻转也能跑</span>
    <span class="token comment"># img[:, :, (2, 1, 0)]这样的操作同样可以实现翻转</span>
    <span class="token comment"># transpose(2, 0, 1)作用是将数据shape从(h,w,3)转变为(3,h,w)，方便计算</span>
    img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># img进行处理后，作内存连续化</span>
    img <span class="token operator">=</span> np<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token comment"># 将img的numpy数组转变为tensor，两者共享内存，指定在显卡上</span>
    img <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    img <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># opencv采用的是256级RGB，即每个像素的RGB强度都为0-255的整数，这一步是归一重整</span>
    img <span class="token operator">/=</span> <span class="token number">255.0</span>
    <span class="token comment"># 如果img张量的维度是3，则将其扩容，一个RGB图片总是三维的</span>
    <span class="token comment"># 扩充维度的原因估计是从一张图片的处理，变成对一堆图片的处理</span>
    <span class="token keyword">if</span> img<span class="token punctuation">.</span>ndimension<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> img<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 返回原图和预处理后的图</span>
    <span class="token keyword">return</span> img0<span class="token punctuation">,</span> img<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这一个方法可以写点东西。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">img <span class="token operator">=</span> letterbox<span class="token punctuation">(</span>img<span class="token punctuation">,</span> new_shape<span class="token operator">=</span>self<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>letterbox函数，深度学习模型输入图片的尺寸为正方形，而数据集中的图片一般为长方形，粗暴的resize会使得图片失真，采用letterbox可以较好的解决这个问题。该方法可以保持图片的长宽比例，剩下的部分采用灰色填充。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjk5MDQ2NA==,size_16,color_FFFFFF,t_70.png" title="图源https://blog.csdn.net/weixin_42990464/article/details/108493781"><p>letterbox函数的返回的第一个量是图片的RGB张量。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这一步是对图片RGB张量的处理。</p><p>一个空白的图像画布，比如2x2，可以理解成一个2x2的矩阵</p><script type="math/tex;mode=display">\left(
\begin{matrix}
 颜色_{11} & 颜色_{12} \\
 颜色_{21} & 颜色_{22}
\end{matrix}
\right)</script><p>RGB色彩就是通过红光Red，绿光Green，和蓝光Blue按照不同的亮度混合的，因此一种颜色可以通过一个RGB矢量表示：</p><script type="math/tex;mode=display">\begin{matrix}[R_{11} &G_{11}&B_{11}]\end{matrix}</script><p>我们假设有一个2*2像素的图片，通过opencv导入后，得到的img张量大概长这样（imread方法读取图片以BGR顺序返回图像数据）：</p><script type="math/tex;mode=display">\left(
\begin{matrix}
 [B_{11} &G_{11}&R_{11}] & [B_{12} &G_{12}&R_{12}]\\
 [B_{21} &G_{21}&R_{21}] & [B_{22} &G_{22}&R_{22}]
\end{matrix}
\right)</script><p>是一个三维张量，shape：(2,2,3) (行像素数，列像素数，3)，可以理解成是一个二维张量矩阵，但里面装的不是数，是RGB亮度矢量，因此是2+1=3维，这样做就可以得到一张图片色彩张量。</p><p>但是imshow方法要求的以RGB的顺序进行输入以重现图像。</p><p>因此先进行倒序：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>长这样：</p><script type="math/tex;mode=display">\left(
\begin{matrix}
 [R_{11} & G_{11}& B_{11}] & [R_{12} & G_{12}& B_{12}] \\
 [R_{21} & G_{21}& B_{21}] & [R_{22} & G_{22}& B_{22}]
\end{matrix}
\right)</script><p>这样的shape还是(2,2,3)，我们经过：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>shape变成了(3,2,2)，长这样：</p><script type="math/tex;mode=display">I_{abc}=\left(
\begin{matrix}
\left[
\begin{matrix}
 R_{11} & R_{12}\\ R_{21} & R_{22}
\end{matrix}
\right]&
\left[
\begin{matrix}
 G_{11} & G_{12}\\ G_{21} & G_{22}
\end{matrix}
\right]&
\left[
\begin{matrix}
 B_{11} & B_{12}\\ B_{21} & B_{22}
\end{matrix}
\right]
\end{matrix}
\right)</script><p>可以理解成本来是一个shape=3的一维向量，但是里面放的不是数了，而是矩阵。</p><p>单独拎出来看，这是一个只有红光强度的单色图层：</p><script type="math/tex;mode=display">红色图层=\begin{matrix}
\left[
\begin{matrix}
 R_{11} & R_{12} \\ R_{21} & R_{22}
\end{matrix}
\right]
\end{matrix}</script><p>这样整个张量就可以写成这个样子：</p><script type="math/tex;mode=display">图片张量=I_{abc}=\left(
\begin{matrix}
红色图层 & 绿色图层 &蓝色图层
\end{matrix}
\right)</script><p>后面我们通过img.unsqueeze(0)进行升维度，结果长这样：</p><script type="math/tex;mode=display">\left(
\left(
\begin{matrix}
\left[
\begin{matrix}
 R_{11} & R_{12}\\ R_{21} & R_{22}
\end{matrix}
\right]&
\left[
\begin{matrix}
 G_{11} & G_{12}\\ G_{21} & G_{22}
\end{matrix}
\right]&
\left[
\begin{matrix}
 B_{11} & B_{12}\\ B_{21} & B_{22}
\end{matrix}
\right]
\end{matrix}
\right)
\right)</script><p>写成这样会更清晰：</p><script type="math/tex;mode=display">\left(I_{1abc}\right)=\left(图1张量\right)</script><p>再来一张照片的话就可以写成这样了：</p><script type="math/tex;mode=display">\left(
\begin{matrix}
I_{1abc} & I_{2abc}
\end{matrix}
\right)=
\left(
\begin{matrix}
图1张量 & 图2张量
\end{matrix}
\right)</script><p>这样就是两帧的色彩张量。</p><pre class="line-numbers language-none"><code class="language-none">img = np.ascontiguousarray(img)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这是内存连续化。</p><p>opencv将图片数据保存到img时，开辟了一组堆内存，在堆内存里保存数据，并把堆内存的操作地址给了图像数据img，这一操作地址存放在了栈内存。</p><p>但是对数据的翻转等操作改变了栈内存对堆内存的映射关系，并没有改变堆内存数据存放，因此此时内存存放看起来不连续了。</p><p>但是连续的内存运算起来更快，所以把堆内存的数据重新排放了一遍，这样就连续了。</p><h4 id="detect"><a href="#detect" class="headerlink" title="detect"></a>detect</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">detect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获得原图和预处理后的图</span>
    im0<span class="token punctuation">,</span> img <span class="token operator">=</span> self<span class="token punctuation">.</span>preprocess<span class="token punctuation">(</span>im<span class="token punctuation">)</span>
    <span class="token comment"># 调用方法拿到model</span>
    <span class="token comment"># 根据github，augment是推理增强</span>
    <span class="token comment"># model本身是一个函数方法，self.m获得这个方法后进行运算，得到一堆预测坐标</span>
    pred <span class="token operator">=</span> self<span class="token punctuation">.</span>m<span class="token punctuation">(</span>img<span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    pred <span class="token operator">=</span> pred<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># NMS非极大值抑制，排除大部分预测坐标</span>
    pred <span class="token operator">=</span> non_max_suppression<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> self<span class="token punctuation">.</span>threshold<span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span>
    <span class="token comment"># 空盒子</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># 对pred中的所有数据</span>
    <span class="token keyword">for</span> det <span class="token keyword">in</span> pred<span class="token punctuation">:</span>
        <span class="token comment"># 如果pred不为空</span>
        <span class="token keyword">if</span> det <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>det<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 不同尺寸图片，坐标的映射改写</span>
            det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> scale_coords<span class="token punctuation">(</span>
                img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 坐标，置信度，类别序号</span>
            <span class="token keyword">for</span> <span class="token operator">*</span>x<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> cls_id <span class="token keyword">in</span> det<span class="token punctuation">:</span>
                lbl <span class="token operator">=</span> self<span class="token punctuation">.</span>names<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>cls_id<span class="token punctuation">)</span><span class="token punctuation">]</span>   <span class="token comment"># 根据序号找到类别</span>
                <span class="token keyword">if</span> lbl <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'person'</span><span class="token punctuation">,</span> <span class="token string">'bicycle'</span><span class="token punctuation">,</span> <span class="token string">'car'</span><span class="token punctuation">,</span> <span class="token string">'motorcycle'</span><span class="token punctuation">,</span> <span class="token string">'bus'</span><span class="token punctuation">,</span> <span class="token string">'truck'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>    <span class="token comment"># 判断是否是这几个类别之一</span>
                <span class="token keyword">pass</span>
                x1<span class="token punctuation">,</span> y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                    <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> lbl<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> boxes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里关键是scale_coords函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> scale_coords<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们在前面把图像进行了缩放，缩放后再拿去跑模型检测，所以得到的坐标是缩放之后的图片坐标，但是我们希望得到原图的坐标，因此进行了这个函数。</p><h3 id="tracker-py"><a href="#tracker-py" class="headerlink" title="tracker.py"></a>tracker.py</h3><h4 id="config载入"><a href="#config载入" class="headerlink" title="config载入"></a>config载入</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">cfg <span class="token operator">=</span> get_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
cfg<span class="token punctuation">.</span>merge_from_file<span class="token punctuation">(</span><span class="token string">"./deep_sort/configs/deep_sort.yaml"</span><span class="token punctuation">)</span>
deepsort <span class="token operator">=</span> DeepSort<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>REID_CKPT<span class="token punctuation">,</span>
                    max_dist<span class="token operator">=</span>cfg<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>MAX_DIST<span class="token punctuation">,</span> min_confidence<span class="token operator">=</span>cfg<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>MIN_CONFIDENCE<span class="token punctuation">,</span>
                    nms_max_overlap<span class="token operator">=</span>cfg<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>NMS_MAX_OVERLAP<span class="token punctuation">,</span> max_iou_distance<span class="token operator">=</span>cfg<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>MAX_IOU_DISTANCE<span class="token punctuation">,</span>
                    max_age<span class="token operator">=</span>cfg<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>MAX_AGE<span class="token punctuation">,</span> n_init<span class="token operator">=</span>cfg<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>N_INIT<span class="token punctuation">,</span> nn_budget<span class="token operator">=</span>cfg<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>NN_BUDGET<span class="token punctuation">,</span>
                    use_cuda<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里引入了一个deepsort对象</p><h4 id="draw-bboxes"><a href="#draw-bboxes" class="headerlink" title="draw_bboxes"></a>draw_bboxes</h4><pre class="line-numbers language-none"><code class="language-none">def draw_bboxes(image, bboxes, line_thickness):     # 画框框
    line_thickness = line_thickness or round(
        0.002 * (image.shape[0] + image.shape[1]) * 0.5) + 1
    # 线宽，要么指定，要么根据图像长宽像素算
    list_pts = []
    point_radius = 4    # 碰撞半径

    for (x1, y1, x2, y2, cls_id, pos_id) in bboxes:
        color = (0, 255, 0)

        # 撞线的点
        check_point_x = x1
        check_point_y = int(y1 + ((y2 - y1) * 0.6))

        c1, c2 = (x1, y1), (x2, y2)     # c1是左上角，c2是右下角
        # 用长方形的对角端点画框，框住检测出来的人的位置
        cv2.rectangle(image, c1, c2, color, thickness=line_thickness, lineType=cv2.LINE_AA)
        # 字符粗细
        font_thickness = max(line_thickness - 1, 1)
        t_size = cv2.getTextSize(cls_id, 0, fontScale=line_thickness / 3, thickness=font_thickness)[0]
        c2 = c1[0] + t_size[0], c1[1] - t_size[1] - 3   # 人框已经画完，现在将c2改为标签框的右上角，此时c1是标签框右下角
        cv2.rectangle(image, c1, c2, color, -1, cv2.LINE_AA)  # 填满一个长方形色块，作为标签颜色背景
        cv2.putText(image, '{} ID-{}'.format(cls_id, pos_id), (c1[0], c1[1] - 2), 0, line_thickness / 3,
                    [225, 255, 255], thickness=font_thickness, lineType=cv2.LINE_AA)    # 在色块上写字
        # 定义碰撞带
        list_pts.append([check_point_x - point_radius, check_point_y - point_radius])
        list_pts.append([check_point_x - point_radius, check_point_y + point_radius])
        list_pts.append([check_point_x + point_radius, check_point_y + point_radius])
        list_pts.append([check_point_x + point_radius, check_point_y - point_radius])
        
        ndarray_pts = np.array(list_pts, np.int32)
        # 人框上的红点
        cv2.fillPoly(image, [ndarray_pts], color=(0, 0, 255))
        # 清空
        list_pts.clear()

    return image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先看看几个opencv函数：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">c1<span class="token punctuation">,</span> c2 <span class="token operator">=</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span>     <span class="token comment"># c1是左上角，c2是右下角</span>
<span class="token comment"># 用长方形的对角端点画框，框住检测出来的人的位置</span>
cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>image<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token operator">=</span>line_thickness<span class="token punctuation">,</span> lineType<span class="token operator">=</span>cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>众所周知只需要两个点就能确定下一个矩形，c1和c2是模型检测出的人或物体所在的坐标，用c1和c2画框框就能把人给框起来，也就是下图的AB点，之后我们把c2坐标写在了C点，这样AC就可以画出标签框的颜色背景。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230111151655450.png"><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 输入参数：要显示的字符，字体编号，字符比例，粗细</span>
cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>cls_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fontScale<span class="token operator">=</span>line_thickness <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span>font_thickness<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment"># 返回值(width,height),bottom</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/5b6d8edc5b8a42a2847856f313d94dfd.png" title="图源https://blog.csdn.net/weixin_43794311/article/details/127438799"><p>我们这里只取了(width,height)，并没有取bottom。</p><pre class="line-numbers language-none"><code class="language-none">cv2.fillPoly(image, [ndarray_pts], color=(0, 0, 255))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="update"><a href="#update" class="headerlink" title="update"></a>update</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>bboxes<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    bbox_xywh <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># x，y，长，宽</span>
    confs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 置信度</span>
    bboxes2draw <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>	<span class="token comment"># 待返回数据组</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>bboxes<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> lbl<span class="token punctuation">,</span> conf <span class="token keyword">in</span> bboxes<span class="token punctuation">:</span>
            obj <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">+</span> x2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y1 <span class="token operator">+</span> y2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                x2 <span class="token operator">-</span> x1<span class="token punctuation">,</span> y2 <span class="token operator">-</span> y1
            <span class="token punctuation">]</span>   <span class="token comment"># 人框的中心坐标，以及方框长宽</span>
            bbox_xywh<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
            confs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>

        xywhs <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>bbox_xywh<span class="token punctuation">)</span>
        confss <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>confs<span class="token punctuation">)</span>

        <span class="token comment"># 下一步是目标跟踪，接收目标检测结果的矩形框坐标跑一遍deepsort</span>
        <span class="token comment"># deepsort会根据先前的帧确定目标检测结果的标识ID：track_id，即判断当前矩形框里的人和前一帧哪个矩形框里的人相同，相同就赋同一个id</span>
        outputs <span class="token operator">=</span> deepsort<span class="token punctuation">.</span>update<span class="token punctuation">(</span>xywhs<span class="token punctuation">,</span> confss<span class="token punctuation">,</span> image<span class="token punctuation">)</span>

        <span class="token keyword">for</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> track_id <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            center_x <span class="token operator">=</span> <span class="token punctuation">(</span>x1 <span class="token operator">+</span> x2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
            center_y <span class="token operator">=</span> <span class="token punctuation">(</span>y1 <span class="token operator">+</span> y2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
            <span class="token comment"># 但是经过deepsort的坐标因为经过一些处理，所以与之前的坐标有不同，所以通过一个search_label的函数寻找其标签</span>
            label <span class="token operator">=</span> search_label<span class="token punctuation">(</span>center_x<span class="token operator">=</span>center_x<span class="token punctuation">,</span> center_y<span class="token operator">=</span>center_y<span class="token punctuation">,</span> bboxes_xyxy<span class="token operator">=</span>bboxes<span class="token punctuation">,</span> max_dist_threshold<span class="token operator">=</span><span class="token number">20.0</span><span class="token punctuation">)</span>
            bboxes2draw<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> label<span class="token punctuation">,</span> track_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">pass</span>
    <span class="token comment"># 最终我们这个函数返回的：人框矩形坐标，标签，track_id</span>
    <span class="token keyword">return</span> bboxes2draw<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里困难的是deepsort的理解，deepsort作为一个目标追踪的模块是比较方便的：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>deepsort <span class="token operator">=</span> DeepSort<span class="token punctuation">(</span>args<span class="token punctuation">.</span>deepsort_checkpoint<span class="token punctuation">)</span>	<span class="token comment"># 实例化</span>
outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>deepsort<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bbox_xcycwh<span class="token punctuation">,</span> cls_conf<span class="token punctuation">,</span> im<span class="token punctuation">)</span>	<span class="token comment">#通过接收目标检测结果进行更新</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>首先我们要经过一个目标检测模块，这里我们用的是yolov5，检测完后，会得到一堆的检测坐标，这些坐标其实就是上文说的人的矩形框对角坐标，把这堆坐标通过self.deepsort.update发给deepsort模块之后，deepsort会对这些矩形框进行序号标记，并且与下一帧进行对比。</p><p>当下一帧又发来一堆检测坐标的时候，deepsort会通过匈牙利算法判断两帧中哪两个矩形框框住的目标是同一个，然后给出框框的序号，这样我们的框框不仅跟着人走，还根据人的特征分发了序号，实现了目标追踪。</p><p>deepsort算法的具体内容另一篇写，这篇写不了那么多了。</p><h4 id="search-label"><a href="#search-label" class="headerlink" title="search_label"></a>search_label</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">search_label</span><span class="token punctuation">(</span>center_x<span class="token punctuation">,</span> center_y<span class="token punctuation">,</span> bboxes_xyxy<span class="token punctuation">,</span> max_dist_threshold<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    在 yolov5 的 bbox 中搜索中心点最接近的label
    :param center_x:
    :param center_y:
    :param bboxes_xyxy:
    :param max_dist_threshold:
    :return: 字符串
    """</span>
    label <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token comment"># min_label = ''</span>
    min_dist <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span>

    <span class="token keyword">for</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> lbl<span class="token punctuation">,</span> conf <span class="token keyword">in</span> bboxes_xyxy<span class="token punctuation">:</span>
        center_x2 <span class="token operator">=</span> <span class="token punctuation">(</span>x1 <span class="token operator">+</span> x2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
        center_y2 <span class="token operator">=</span> <span class="token punctuation">(</span>y1 <span class="token operator">+</span> y2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>

        <span class="token comment"># 横纵距离都小于 max_dist</span>
        min_x <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>center_x2 <span class="token operator">-</span> center_x<span class="token punctuation">)</span>
        min_y <span class="token operator">=</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>center_y2 <span class="token operator">-</span> center_y<span class="token punctuation">)</span>

        <span class="token keyword">if</span> min_x <span class="token operator">&lt;</span> max_dist_threshold <span class="token keyword">and</span> min_y <span class="token operator">&lt;</span> max_dist_threshold<span class="token punctuation">:</span>
            <span class="token comment"># 距离阈值，判断是否在允许误差范围内</span>
            <span class="token comment"># 取 x, y 方向上的距离平均值</span>
            avg_dist <span class="token operator">=</span> <span class="token punctuation">(</span>min_x <span class="token operator">+</span> min_y<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
            <span class="token keyword">if</span> min_dist <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">:</span>
                <span class="token comment"># 第一次赋值</span>
                min_dist <span class="token operator">=</span> avg_dist
                <span class="token comment"># 赋值label</span>
                label <span class="token operator">=</span> lbl
                <span class="token keyword">pass</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># 若不是第一次，则距离小的优先</span>
                <span class="token keyword">if</span> avg_dist <span class="token operator">&lt;</span> min_dist<span class="token punctuation">:</span>
                    min_dist <span class="token operator">=</span> avg_dist
                    <span class="token comment"># label</span>
                    label <span class="token operator">=</span> lbl
                <span class="token keyword">pass</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">return</span> label<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这一个函数是因为，我们在拿到deepsort返回的矩形框坐标的时候，实际上跟我们发送过去的矩形框坐标有一点出入，但只相差几个像素，所以我们完全可以根据像素距离确定框框坐标的对应关系。</p><p>很容易看懂，就是把deepsort的矩形框中心坐标发进去，然后跟yolov5检测出的所有框框中心坐标对比，看跟哪个最近，把最近那个框框的标签取下来返回就行，看得懂python就能看得懂这段。</p><h3 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a>main.py</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    <span class="token comment"># 背景幕布，一个1080*1920的零矩阵，二维张量</span>
    mask_image_temp <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1080</span><span class="token punctuation">,</span> <span class="token number">1920</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    <span class="token comment"># 蓝色撞线带</span>
    list_pts_blue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">204</span><span class="token punctuation">,</span> <span class="token number">305</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">227</span><span class="token punctuation">,</span> <span class="token number">431</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">605</span><span class="token punctuation">,</span> <span class="token number">522</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1101</span><span class="token punctuation">,</span> <span class="token number">464</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1900</span><span class="token punctuation">,</span> <span class="token number">601</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1902</span><span class="token punctuation">,</span> <span class="token number">495</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1125</span><span class="token punctuation">,</span> <span class="token number">379</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">604</span><span class="token punctuation">,</span> <span class="token number">437</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     <span class="token punctuation">[</span><span class="token number">299</span><span class="token punctuation">,</span> <span class="token number">375</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">267</span><span class="token punctuation">,</span> <span class="token number">289</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    ndarray_pts_blue <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>list_pts_blue<span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
    polygon_blue_value_1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>mask_image_temp<span class="token punctuation">,</span> <span class="token punctuation">[</span>ndarray_pts_blue<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 色彩通带升维度，由原来的1080*1920的矩阵，升成三维张量，1080*1920的矩阵上放的不再是数而是RGB向量</span>
    polygon_blue_value_1 <span class="token operator">=</span> polygon_blue_value_1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>

    <span class="token comment"># 填充第二个多边形撞线带</span>
    mask_image_temp <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1080</span><span class="token punctuation">,</span> <span class="token number">1920</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    list_pts_yellow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">181</span><span class="token punctuation">,</span> <span class="token number">305</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">207</span><span class="token punctuation">,</span> <span class="token number">442</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">603</span><span class="token punctuation">,</span> <span class="token number">544</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1107</span><span class="token punctuation">,</span> <span class="token number">485</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1898</span><span class="token punctuation">,</span> <span class="token number">625</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1893</span><span class="token punctuation">,</span> <span class="token number">701</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1101</span><span class="token punctuation">,</span> <span class="token number">568</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       <span class="token punctuation">[</span><span class="token number">594</span><span class="token punctuation">,</span> <span class="token number">637</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">118</span><span class="token punctuation">,</span> <span class="token number">483</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">109</span><span class="token punctuation">,</span> <span class="token number">303</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    ndarray_pts_yellow <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>list_pts_yellow<span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
    polygon_yellow_value_2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>mask_image_temp<span class="token punctuation">,</span> <span class="token punctuation">[</span>ndarray_pts_yellow<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    polygon_yellow_value_2 <span class="token operator">=</span> polygon_yellow_value_2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
    <span class="token comment"># 撞线检测用mask，包含2个polygon，（值范围 0、1、2），供撞线计算使用</span>
    <span class="token comment"># mask上，值0像素无碰撞检测，值1蓝色检测，值2黄色检测</span>
    polygon_mask_blue_and_yellow <span class="token operator">=</span> polygon_blue_value_1 <span class="token operator">+</span> polygon_yellow_value_2

    <span class="token comment"># 缩小尺寸，1920x1080-&gt;960x540</span>
    polygon_mask_blue_and_yellow <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>polygon_mask_blue_and_yellow<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">960</span><span class="token punctuation">,</span> <span class="token number">540</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 蓝 色盘 b,g,r</span>
    blue_color_plate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 蓝 polygon图片</span>
    blue_image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>polygon_blue_value_1 <span class="token operator">*</span> blue_color_plate<span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

    <span class="token comment"># 黄 色盘</span>
    yellow_color_plate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>
    <span class="token comment"># 黄 polygon图片</span>
    yellow_image <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>polygon_yellow_value_2 <span class="token operator">*</span> yellow_color_plate<span class="token punctuation">,</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

    <span class="token comment"># 彩色图片（值范围 0-255）</span>
    color_polygons_image <span class="token operator">=</span> blue_image <span class="token operator">+</span> yellow_image
    <span class="token comment"># 缩小尺寸，1920x1080-&gt;960x540</span>
    color_polygons_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>color_polygons_image<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">960</span><span class="token punctuation">,</span> <span class="token number">540</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># list 与蓝色polygon重叠</span>
    list_overlapping_blue_polygon <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># list 与黄色polygon重叠</span>
    list_overlapping_yellow_polygon <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># 进入数量</span>
    down_count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># 离开数量</span>
    up_count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># 设置字体类型</span>
    font_draw_number <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX
    <span class="token comment"># 设置字体位置</span>
    draw_text_postion <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">960</span> <span class="token operator">*</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">540</span> <span class="token operator">*</span> <span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 初始化 yolov5</span>
    detector <span class="token operator">=</span> Detector<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 打开视频</span>
    capture <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token string">r'video\test.mp4'</span><span class="token punctuation">)</span>

    <span class="token comment"># 视频帧读取</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># 读取每帧图片</span>
        _<span class="token punctuation">,</span> im <span class="token operator">=</span> capture<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 没读取出图片即视频结束，break循环</span>
        <span class="token keyword">if</span> im <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

        <span class="token comment"># 缩小尺寸，1920x1080-&gt;960x540</span>
        im <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>im<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">960</span><span class="token punctuation">,</span> <span class="token number">540</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 初始化空列表bboxs</span>
        list_bboxs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 将缩小后的图片交给detector对象进行探测</span>
        <span class="token comment"># 返回值(x1, y1, x2, y2, lbl, conf)</span>
        bboxes <span class="token operator">=</span> detector<span class="token punctuation">.</span>detect<span class="token punctuation">(</span>im<span class="token punctuation">)</span>

        <span class="token comment"># 如果画面中有bbox，即detector探测到待检测对象</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>bboxes<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># 我们就把detector探测到的坐标发给tracker，把图片update到跟踪器</span>
            list_bboxs <span class="token operator">=</span> tracker<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bboxes<span class="token punctuation">,</span> im<span class="token punctuation">)</span>

            <span class="token comment"># 画框</span>
            <span class="token comment"># 画撞线检测点，(x1，y1 + ((y2 - y1) * 0.6)，并且将图片返回（当前取了0.6为偏移量，在tracker.py30行）</span>
            output_image_frame <span class="token operator">=</span> tracker<span class="token punctuation">.</span>draw_bboxes<span class="token punctuation">(</span>im<span class="token punctuation">,</span> list_bboxs<span class="token punctuation">,</span> line_thickness<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword">pass</span>    <span class="token comment"># 空命令，类似C里的分号</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 如果画面中没有bbox，直接返回图片</span>
            output_image_frame <span class="token operator">=</span> im
        <span class="token keyword">pass</span>

        <span class="token comment"># 输出图片</span>
        output_image_frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>add<span class="token punctuation">(</span>output_image_frame<span class="token punctuation">,</span> color_polygons_image<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>list_bboxs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># ----------------------判断撞线----------------------</span>
            <span class="token keyword">for</span> item_bbox <span class="token keyword">in</span> list_bboxs<span class="token punctuation">:</span>
                x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> label<span class="token punctuation">,</span> track_id <span class="token operator">=</span> item_bbox

                <span class="token comment"># 撞线检测点，(x1，y1)，y方向偏移比例 0.0~1.0</span>
                y1_offset <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y1 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y2 <span class="token operator">-</span> y1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token comment"># 撞线的点</span>
                y <span class="token operator">=</span> y1_offset
                x <span class="token operator">=</span> x1

                <span class="token keyword">if</span> polygon_mask_blue_and_yellow<span class="token punctuation">[</span>y<span class="token punctuation">,</span> x<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    <span class="token comment"># 如果撞蓝碰撞带，而且该检测点所属id未被记录，则记录</span>
                    <span class="token keyword">if</span> track_id <span class="token keyword">not</span> <span class="token keyword">in</span> list_overlapping_blue_polygon<span class="token punctuation">:</span>
                        list_overlapping_blue_polygon<span class="token punctuation">.</span>append<span class="token punctuation">(</span>track_id<span class="token punctuation">)</span>
                    <span class="token keyword">pass</span>

                    <span class="token comment"># 判断 黄碰撞带 list 里是否有此 track_id</span>
                    <span class="token comment"># 有此 track_id，则 认为是 外出方向</span>
                    <span class="token keyword">if</span> track_id <span class="token keyword">in</span> list_overlapping_yellow_polygon<span class="token punctuation">:</span>
                        <span class="token comment"># 外出+1</span>
                        up_count <span class="token operator">+=</span> <span class="token number">1</span>

                        <span class="token keyword">print</span><span class="token punctuation">(</span>
                            <span class="token string-interpolation"><span class="token string">f'类别: </span><span class="token interpolation"><span class="token punctuation">{</span>label<span class="token punctuation">}</span></span><span class="token string"> | id: </span><span class="token interpolation"><span class="token punctuation">{</span>track_id<span class="token punctuation">}</span></span><span class="token string"> | 上行撞线 | 上行撞线总数: </span><span class="token interpolation"><span class="token punctuation">{</span>up_count<span class="token punctuation">}</span></span><span class="token string"> | 上行id列表: </span><span class="token interpolation"><span class="token punctuation">{</span>list_overlapping_yellow_polygon<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

                        <span class="token comment"># 删除 黄polygon list 中的此id</span>
                        list_overlapping_yellow_polygon<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>track_id<span class="token punctuation">)</span>

                        <span class="token keyword">pass</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token comment"># 无此 track_id，不做其他操作</span>
                        <span class="token keyword">pass</span>

                <span class="token keyword">elif</span> polygon_mask_blue_and_yellow<span class="token punctuation">[</span>y<span class="token punctuation">,</span> x<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                    <span class="token comment"># 如果撞黄碰撞带，而且该检测点所属id未被记录，则记录</span>
                    <span class="token keyword">if</span> track_id <span class="token keyword">not</span> <span class="token keyword">in</span> list_overlapping_yellow_polygon<span class="token punctuation">:</span>
                        list_overlapping_yellow_polygon<span class="token punctuation">.</span>append<span class="token punctuation">(</span>track_id<span class="token punctuation">)</span>
                    <span class="token keyword">pass</span>

                    <span class="token comment"># 判断蓝碰撞带 list 里是否有此 track_id</span>
                    <span class="token comment"># 有此 track_id，则 认为是 进入方向</span>
                    <span class="token keyword">if</span> track_id <span class="token keyword">in</span> list_overlapping_blue_polygon<span class="token punctuation">:</span>
                        <span class="token comment"># 进入+1</span>
                        down_count <span class="token operator">+=</span> <span class="token number">1</span>

                        <span class="token keyword">print</span><span class="token punctuation">(</span>
                            <span class="token string-interpolation"><span class="token string">f'类别: </span><span class="token interpolation"><span class="token punctuation">{</span>label<span class="token punctuation">}</span></span><span class="token string"> | id: </span><span class="token interpolation"><span class="token punctuation">{</span>track_id<span class="token punctuation">}</span></span><span class="token string"> | 下行撞线 | 下行撞线总数: </span><span class="token interpolation"><span class="token punctuation">{</span>down_count<span class="token punctuation">}</span></span><span class="token string"> | 下行id列表: </span><span class="token interpolation"><span class="token punctuation">{</span>list_overlapping_blue_polygon<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

                        <span class="token comment"># 删除 蓝polygon list 中的此id</span>
                        list_overlapping_blue_polygon<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>track_id<span class="token punctuation">)</span>
                        <span class="token keyword">pass</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token comment"># 无此 track_id，不做其他操作</span>
                        <span class="token keyword">pass</span>
                    <span class="token keyword">pass</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">pass</span>
                <span class="token keyword">pass</span>

            <span class="token keyword">pass</span>

            <span class="token comment"># ----------------------清除无用id----------------------</span>
            <span class="token comment"># 先把所有在碰撞带的id拼一起</span>
            list_overlapping_all <span class="token operator">=</span> list_overlapping_yellow_polygon <span class="token operator">+</span> list_overlapping_blue_polygon
            <span class="token comment"># 查查看这些经过碰撞带的id是不是都在这帧被yolo和deepsort检测到</span>
            <span class="token keyword">for</span> id1 <span class="token keyword">in</span> list_overlapping_all<span class="token punctuation">:</span>
                is_found <span class="token operator">=</span> <span class="token boolean">False</span>
                <span class="token keyword">for</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> bbox_id <span class="token keyword">in</span> list_bboxs<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> bbox_id <span class="token operator">==</span> id1<span class="token punctuation">:</span>
                        is_found <span class="token operator">=</span> <span class="token boolean">True</span>
                        <span class="token keyword">break</span>
                    <span class="token keyword">pass</span>
                <span class="token keyword">pass</span>

                <span class="token keyword">if</span> <span class="token keyword">not</span> is_found<span class="token punctuation">:</span>
                    <span class="token comment"># 如果没找到，删除id</span>
                    <span class="token keyword">if</span> id1 <span class="token keyword">in</span> list_overlapping_yellow_polygon<span class="token punctuation">:</span>
                        list_overlapping_yellow_polygon<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>id1<span class="token punctuation">)</span>
                    <span class="token keyword">pass</span>
                    <span class="token keyword">if</span> id1 <span class="token keyword">in</span> list_overlapping_blue_polygon<span class="token punctuation">:</span>
                        list_overlapping_blue_polygon<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>id1<span class="token punctuation">)</span>
                    <span class="token keyword">pass</span>
                <span class="token keyword">pass</span>
            list_overlapping_all<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">pass</span>
        	<span class="token comment"># ----------------------清除无用id结束----------------------</span>
            <span class="token comment"># 清空list</span>
            list_bboxs<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">pass</span>
        	
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 如果图像中没有任何的bbox，则清空list</span>
            list_overlapping_blue_polygon<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            list_overlapping_yellow_polygon<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">pass</span>
        <span class="token comment"># 进出人数统计显示文本</span>
        text_draw <span class="token operator">=</span> <span class="token string">'DOWN: '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>down_count<span class="token punctuation">)</span> <span class="token operator">+</span> \
                    <span class="token string">' , UP: '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>up_count<span class="token punctuation">)</span>
        <span class="token comment"># 文本放在画面上</span>
        output_image_frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token operator">=</span>output_image_frame<span class="token punctuation">,</span> text<span class="token operator">=</span>text_draw<span class="token punctuation">,</span>
                                         org<span class="token operator">=</span>draw_text_postion<span class="token punctuation">,</span>
                                         fontFace<span class="token operator">=</span>font_draw_number<span class="token punctuation">,</span>
                                         fontScale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> thickness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># 播放</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">,</span> output_image_frame<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">pass</span>
    <span class="token keyword">pass</span>
    <span class="token comment"># 释放内存</span>
    capture<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 关闭窗口</span>
    cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>个人觉得已经写得挺清晰了，跑一遍程序看看：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112122148499.png"><p>我们会发现这个id:32的person一共上行撞线了两次，下行撞线了一次，显然这里有碰撞带比较靠近，碰撞点抖动导致的问题，但是也不应该出现两次上行的检测。</p><p>我们重新看一下代码，判断上下行是通过蓝黄碰撞带实现的，进出的时候记录下他们碰撞带碰撞的先后顺序，先蓝后黄则下，先黄后蓝则上，如果视频里没有捣乱的人，那么每个人都只会碰撞到一次蓝带和一次黄带。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230109154119832.png" title="旧图新用"><p>比如有人先经过蓝带，此时我们在蓝带碰撞列表中记下他的id，再经过黄带，此时我们在黄带碰撞列表中记下他的id，此时是先蓝后黄，所以是下行，我们下行总数加1，但是他还在黄带上，所以要把蓝带碰撞列表的id删掉，否则就会重复加1，因为我们认为蓝带是不会重复碰撞的。</p><p>但是实际不是这样的，首先我们这个目标检测还不足够精准，撞点会出现小范围的抖动，其次碰撞带相隔太短，小抖动就会导致从蓝带跑到黄带。</p><p>我们有两种方法解决：</p><p>第一种是，我们重新改一下碰撞带，让他们之间距离大一点，保证撞点的小范围抖动不会出现从蓝带跑到黄带的判定。</p><p>第二种是，我们的碰撞带足够宽，即便撞点有小范围的抖动，我们仍然能够保证撞点第一个撞到的碰撞带是正确的。</p><p>我们可以定义一个新的列表记录已经检测过上下行判断的id：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">list_id_overlapping <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>并把if部分小加一些内容</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> track_id <span class="token keyword">in</span> list_overlapping_blue_polygon <span class="token keyword">and</span> track_id <span class="token keyword">not</span> <span class="token keyword">in</span> list_id_overlapping<span class="token punctuation">:</span>
    <span class="token comment"># 进入+1</span>
    down_count <span class="token operator">+=</span> <span class="token number">1</span>
    list_id_overlapping<span class="token punctuation">.</span>append<span class="token punctuation">(</span>track_id<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> track_id <span class="token keyword">in</span> list_overlapping_yellow_polygon <span class="token keyword">and</span> track_id <span class="token keyword">not</span> <span class="token keyword">in</span> list_id_overlapping<span class="token punctuation">:</span>
    <span class="token comment"># 外出+1</span>
    up_count <span class="token operator">+=</span> <span class="token number">1</span>
    list_id_overlapping<span class="token punctuation">.</span>append<span class="token punctuation">(</span>track_id<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>我们再跑一遍：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112133308420.png"><p>但是根据视频，44号应该是上行，我们在44号第一次被记录的时候设置一个breakpoint，把那帧图片用imwrite保存下来看看：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112134448214.png"><p>至少在我看来应该是碰到黄色才对，但是程序记录他碰到蓝色了…</p><p>再看看碰撞点坐标：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112135329291.png"><p>是(58,228)，放去gimp查看像素：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112135711534.png"><p>圈住的点应该刚好就是(58,228)，也应该就是黄色碰撞带才对，看看附近的点值。</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112142019419.png"><p>（0是幕布，1是蓝色碰撞带，2是黄色碰撞带）突然多了几行边界的1，可能是定义的时候出了问题，也可能是opencv转换的时候出了问题，先看看未转换前的色值：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112142521106.png"><p>确实是因为opencv的转换导致的，我推测这里应该是转换的时候把部分边界作了均值处理，我们把2改成3看看会不会有所变化.</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112143232011.png"><p>这应该是作了些均值处理，我们把它取成10，估计均值处理就不会出现1了，代码已经讲得比较清楚了，这部分的修改就不重新放上去了。</p><p>现在结果应该就对了：</p><img src="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/image-20230112150209019.png"><p>yolo模型和deepsort算法分另外两篇发，项目工程架构到这里写完了。</p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="/Lillia.github.io/about" rel="external nofollow noreferrer">LYC</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://github.com/DidUSeeMyElk/Lillia.github.io/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/">https://github.com/DidUSeeMyElk/Lillia.github.io/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/Lillia.github.io/about" target="_blank">LYC</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/Lillia.github.io/tags/blog/"><span class="chip bg-color">blog</span></a> <a href="/Lillia.github.io/tags/DeepLearning/"><span class="chip bg-color">DeepLearning</span></a> <a href="/Lillia.github.io/tags/YOLOv5/"><span class="chip bg-color">YOLOv5</span></a> <a href="/Lillia.github.io/tags/DeepSORT/"><span class="chip bg-color">DeepSORT</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="/Lillia.github.io/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/Lillia.github.io/libs/share/js/social-share.min.js"></script></div></div></div><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/Lillia.github.io/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/Lillia.github.io/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function () {
        $('.tabs').tabs();
    });</script></div></div><style>.waline-card{margin:1.5rem auto}.waline-card .card-content{padding:20px 20px 5px 20px}#waline p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#waline blockquote p{text-indent:.2rem}#waline a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#waline img{max-width:100%;cursor:pointer}#waline ol li{list-style-type:decimal}#waline ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#waline ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#waline ul li{list-style-type:disc}#waline ul ul li{list-style-type:circle}#waline table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#waline table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#waline table th{background-color:#f2f2f2;min-width:80px}#waline table td{min-width:80px}#waline h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#waline h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#waline h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#waline h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#waline h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#waline h6{font-size:1rem;line-height:1.3rem}#waline p{font-size:1rem;line-height:1.5rem}#waline hr{margin:12px 0;border:0;border-top:1px solid #ccc}#waline blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#waline pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#waline code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#waline pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#waline pre[class*=language-]{padding:1.2em;margin:.5em 0}#waline code[class*=language-],pre[class*=language-]{color:#e8eaf6}#waline [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#waline b,strong{font-weight:700}#waline dfn{font-style:italic}#waline small{font-size:85%}#waline cite{font-style:normal}#waline mark{background-color:#fcf8e3;padding:.2em}#waline table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#waline table th{background-color:#f2f2f2;min-width:80px}#waline table td{min-width:80px}#waline [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}</style><div class="card waline-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="waline" class="card-content" style="display:grid"></div></div><script src="/Lillia.github.io/libs/waline/Waline.min.js"></script><script>new Waline({
        el: '#waline',
        serverURL: 'https://waline-comment-ftvhqdtn7-diduseemyelk.vercel.app/',
        avatar: 'mm'    
    });</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="far fa-dot-circle"></i> &nbsp;本篇</div><div class="card"><a href="/Lillia.github.io/2023/01/11/xing-ren-jian-ce-demo/"><div class="card-image"><img src="/Lillia.github.io/medias/featureimages/4.jpg" class="responsive-img" alt="行人检测demo"> <span class="card-title">行人检测demo</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2023-01-11</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/Lillia.github.io/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" class="post-category">深度学习</a></span></div></div><div class="card-action article-tags"><a href="/Lillia.github.io/tags/blog/"><span class="chip bg-color">blog</span></a> <a href="/Lillia.github.io/tags/DeepLearning/"><span class="chip bg-color">DeepLearning</span></a> <a href="/Lillia.github.io/tags/YOLOv5/"><span class="chip bg-color">YOLOv5</span></a> <a href="/Lillia.github.io/tags/DeepSORT/"><span class="chip bg-color">DeepSORT</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/Lillia.github.io/2022/02/11/51-dan-pian-ji-duo-gong-neng-zhong/"><div class="card-image"><img src="/Lillia.github.io/medias/featureimages/21.jpg" class="responsive-img" alt="51单片机多功能钟"> <span class="card-title">51单片机多功能钟</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2022-02-11</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/Lillia.github.io/categories/%E5%8D%95%E7%89%87%E6%9C%BA/" class="post-category">单片机</a></span></div></div><div class="card-action article-tags"><a href="/Lillia.github.io/tags/blog/"><span class="chip bg-color">blog</span></a> <a href="/Lillia.github.io/tags/%E5%8D%95%E7%89%87%E6%9C%BA/"><span class="chip bg-color">单片机</span></a></div></div></div></div></article></div><script src="/Lillia.github.io/libs/codeBlock/codeBlockFuction.js"></script><script src="/Lillia.github.io/libs/prism/prism.min.js"></script><script src="/Lillia.github.io/libs/codeBlock/codeLang.js"></script><script src="/Lillia.github.io/libs/codeBlock/codeCopy.js"></script><script src="/Lillia.github.io/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/Lillia.github.io/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
    });</script><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2022-2023</span> <a href="/Lillia.github.io/about" target="_blank">LYC</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">10k</span> <span id="busuanzi_container_site_pv">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span></span> <span id="busuanzi_container_site_uv">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "12";
                        var startDate = "11";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/DidUSeeMyElk" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i></a><a href="mailto:e1kovo@stu2019.jnu.edu.cn" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i></a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1035603730" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1035603730" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a><a href="https://weibo.com/5602005765" class="tooltipped" target="_blank" data-tooltip="关注我的微博" data-position="top" data-delay="50"><i class="fab fa-weibo"></i></a> <a href="https://www.zhihu.com/people/candyseven-50" class="tooltipped" target="_blank" data-tooltip="关注我的知乎" data-position="top" data-delay="50"><i class="fab fa-zhihu1">知</i></a><a href="/Lillia.github.io/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script>$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/Lillia.github.io/search.xml', 'searchInput', 'searchResult');
});</script><div class="stars-con"><div id="stars"></div><div id="stars2"></div><div id="stars3"></div></div><script>function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/Lillia.github.io/libs/materialize/materialize.min.js"></script><script src="/Lillia.github.io/libs/masonry/masonry.pkgd.min.js"></script><script src="/Lillia.github.io/libs/aos/aos.js"></script><script src="/Lillia.github.io/libs/scrollprogress/scrollProgress.min.js"></script><script src="/Lillia.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/Lillia.github.io/js/matery.js"></script><script src="https://diduseemyelk.github.io/Lillia.github.io/live2d-widget/autoload.js"></script><script src="https://ssl.captcha.qq.com/TCaptcha.js"></script><script src="/Lillia.github.io/libs/others/TencentCaptcha.js"></script><button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button><script>(function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();</script><script src="/Lillia.github.io/libs/others/clicklove.js" async></script><script async src="/Lillia.github.io/libs/others/busuanzi.pure.mini.js"></script><div style="position:fixed;bottom:125px;right:16px;cursor:pointer"><a title="兔小巢" target="_blank" rel="noopener" href="https://support.qq.com/products/491953"><i class="fa fa-comments fa-3x" aria-hidden="true"></i></a></div><script src="/Lillia.github.io/libs/instantpage/instantpage.js" type="module"></script></body></html>